import { loginUser } from '@affine-test/kit/utils/cloud';
import { expect } from '@playwright/test';

import { test } from '../base/base-test';

const base64 =
  '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';

const image = {
  name: 'image.jpeg',
  mimeType: 'image/jpeg',
  buffer: Buffer.from(base64, 'base64'),
};

test.describe('AIAction/GenerateImageCaption', () => {
  test.beforeEach(async ({ page, utils }) => {
    const user = await utils.testUtils.getUser();
    await loginUser(page, user);
    await utils.testUtils.setupTestEnvironment(page);
    await utils.chatPanel.openChatPanel(page);
  });

  test('should generate image caption', async ({ page, utils }) => {
    const { generateCaption } = await utils.editor.askAIWithImage(page, image);
    const { answer, responses } = await generateCaption();
    await expect(answer).toHaveText(/cat|kitten/i);
    await expect(responses).toEqual(
      new Set(['insert-below', 'use-as-caption', 'replace-selection'])
    );
  });

  test('should show chat history in chat panel', async ({ page, utils }) => {
    const { generateCaption } = await utils.editor.askAIWithImage(page, image);
    const { answer } = await generateCaption();
    await expect(answer).toHaveText(/cat|kitten/i);
    const insert = answer.getByTestId('answer-insert-below');
    await insert.click();
    await utils.chatPanel.waitForHistory(page, [
      {
        role: 'action',
      },
    ]);
    const {
      message,
      answer: panelAnswer,
      actionName,
    } = await utils.chatPanel.getLatestAIActionMessage(page);
    await expect(message.getByTestId('original-images')).toBeVisible();
    await expect(panelAnswer).toHaveText(/cat|kitten/i);
    await expect(actionName).toHaveText(/Generate a caption/);
  });
});
